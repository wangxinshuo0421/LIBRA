数据包接收过程：
`point-to-point/model/qbb-net-device.cc/h`: 
    QbbNetDevice::Receive(Ptr<Packet> packet)
        if switch rcv:
            m_node->SwitchReceiveFromDevice(this, packet, ch);
            `point-to-point/model/switch-node.cc/h`: 
                SwitchReceiveFromDevice->SendToDev : SendToDev 先check buffer size，然后决定是否丢包，可以在此处修改交换机发送队列
        if host:
            m_rdmaReceiveCb(packet, ch);




QbbHelper qbb是支持PFC的设备
[1] 2011. IEEE. 802.11Qbb. Priority based flow control. (2011).

GetNodeType() == 0 // is server
GetNodeType() == 1 // is switch

switch-node.cc: SwitchNode::GetOutDev(Ptr<const Packet> p, CustomHeader &ch) 根据ecmp计算出口

rdma-hw::RdmaHw::GetNxtPacket 根据qp中存的信息，生成数据包并发送

协议栈自上而下简化为：
--> RdmaClient : 创建qp
--> RdmaDriver ：添加qp
--> RdmaHw ：拥塞控制，根据qp生成发包，处理收包并发送cnp
--> QbbNetDevice ：端口抽象，pfc控制
--> Swich节点发送。

rdma data发送流程：rdma-client.StartApplication() -> rdma-driver.AddQueuePair() -> rdma-hw.NewQp() -> qbb-net-device.DequeueAndTransmit() -> rdma-hw.GetNxtPacket()
rdma data接收流程：rx:qbb-net-device.Receive() -> rx:rdma-hw.Receive() -> rx:rdma-hw.ReceiveUdp() -> rx:rdma-hw.ReceiverCheckSeq (rx_seq >= data_size)-> rx:qbb-net-device.RdmaEnqueueHighPrioQ(ack) -> rx:qbb-net-device.TriggerTransmit() -> tx:rcv ack -> tx:rdma-driver->QpComplete() -> rx:rdma-hw.QpComplete()
-> tx: rdma-client.Finish()

接收端收完数据后，发送ack，每包ack机制
接收端监测到丢包后（rx_seq > expect_seq）,发送nack
难点：接收端根据packet size（seq：已接收的数据偏移，类似TCP），而非PSN进行ack/nack的生成，需要改成窗口机制！！！


fct实验记录：
单条流量：
2 1 3 100 2000000 2
seanet：0b000202 0b000102 10000 100 2000000 2000000000 **28585135** 675360
normal：0b000202 0b000102 10000 100 2000000 2000000000 **737189** 675360

32条流量：
2 1 3 100 5000000 2
3 1 3 100 2000000 2
4 1 3 100 2000000 2
5 1 3 100 2000000 2
6 1 3 100 2000000 2
7 1 3 100 2000000 2
8 1 3 100 2000000 2
9 1 3 100 2000000 2
10 1 3 100 2000000 2
11 1 3 100 2000000 2
12 1 3 100 2000000 2
13 1 3 100 2000000 2
14 1 3 100 2000000 2
15 1 3 100 2000000 2
16 1 3 100 2000000 2
17 1 3 100 2000000 2
18 1 3 100 2000000 2
19 1 3 100 2000000 2
20 1 3 100 2000000 2
21 1 3 100 2000000 2
22 1 3 100 2000000 2
23 1 3 100 2000000 2
24 1 3 100 2000000 2
25 1 3 100 2000000 2
26 1 3 100 2000000 2
27 1 3 100 2000000 2
28 1 3 100 2000000 2
29 1 3 100 2000000 2
30 1 3 100 2000000 2
31 1 3 100 2000000 2
32 1 3 100 2000000 2
33 1 3 100 2000000 2

normal
0b002002 0b000102 10000 100 2000000 2000000000 10497446 679520
0b001a02 0b000102 10000 100 2000000 2000000000 10828832 675360
0b001102 0b000102 10000 100 2000000 2000000000 10929450 675360
0b000902 0b000102 10000 100 2000000 2000000000 11114702 675360
0b001802 0b000102 10000 100 2000000 2000000000 11120241 675360
0b002102 0b000102 10000 100 2000000 2000000000 11123995 679520
0b000602 0b000102 10000 100 2000000 2000000000 11238870 675360
0b001b02 0b000102 10000 100 2000000 2000000000 11242374 675360
0b001c02 0b000102 10000 100 2000000 2000000000 11281129 675360
0b001302 0b000102 10000 100 2000000 2000000000 11295104 675360
0b000502 0b000102 10000 100 2000000 2000000000 11301737 675360
0b000d02 0b000102 10000 100 2000000 2000000000 11340158 675360
0b001e02 0b000102 10000 100 2000000 2000000000 11358355 675360
0b000802 0b000102 10000 100 2000000 2000000000 11378096 675360
0b001f02 0b000102 10000 100 2000000 2000000000 11395103 675360
0b001902 0b000102 10000 100 2000000 2000000000 11411585 675360
0b000a02 0b000102 10000 100 2000000 2000000000 11419346 675360
0b001702 0b000102 10000 100 2000000 2000000000 11479203 675360
0b001d02 0b000102 10000 100 2000000 2000000000 11637148 675360
0b001502 0b000102 10000 100 2000000 2000000000 12358257 675360
0b001002 0b000102 10000 100 2000000 2000000000 12416283 675360
0b001602 0b000102 10000 100 2000000 2000000000 12446389 675360
0b000702 0b000102 10000 100 2000000 2000000000 12518817 675360
0b000c02 0b000102 10000 100 2000000 2000000000 12519165 675360
0b000f02 0b000102 10000 100 2000000 2000000000 12563297 675360
0b001402 0b000102 10000 100 2000000 2000000000 12585914 675360
0b000302 0b000102 10000 100 2000000 2000000000 12593614 675360
0b000b02 0b000102 10000 100 2000000 2000000000 12595805 675360
0b000e02 0b000102 10000 100 2000000 2000000000 12677487 675360
0b001202 0b000102 10000 100 2000000 2000000000 12693676 675360
0b000402 0b000102 10000 100 2000000 2000000000 12706861 675360
0b000202 0b000102 10000 100 5000000 2000000000 13763151 1681440


seanet:
0b001c02 0b000102 10000 100 2000000 2000000000 99707993 675360
0b001a02 0b000102 10000 100 2000000 2000000000 100088377 675360
0b001002 0b000102 10000 100 2000000 2000000000 101472551 675360
0b001602 0b000102 10000 100 2000000 2000000000 101581759 675360
0b000b02 0b000102 10000 100 2000000 2000000000 101668913 675360
0b000602 0b000102 10000 100 2000000 2000000000 102982754 675360
0b001202 0b000102 10000 100 2000000 2000000000 103335928 675360
0b000d02 0b000102 10000 100 2000000 2000000000 103722598 675360
0b001702 0b000102 10000 100 2000000 2000000000 103740014 675360
0b000202 0b000102 10000 100 2000000 2000000000 103981754 675360
0b001302 0b000102 10000 100 2000000 2000000000 104374009 675360
0b000802 0b000102 10000 100 2000000 2000000000 104421903 675360
0b001802 0b000102 10000 100 2000000 2000000000 104709767 675360
0b001e02 0b000102 10000 100 2000000 2000000000 104820928 675360
0b001102 0b000102 10000 100 2000000 2000000000 105085065 675360
0b001402 0b000102 10000 100 2000000 2000000000 105728804 675360
0b001b02 0b000102 10000 100 2000000 2000000000 105961754 675360
0b000402 0b000102 10000 100 2000000 2000000000 106052316 675360
0b001902 0b000102 10000 100 2000000 2000000000 106429754 675360
0b000c02 0b000102 10000 100 2000000 2000000000 107347754 675360
0b000f02 0b000102 10000 100 2000000 2000000000 107507266 675360
0b000502 0b000102 10000 100 2000000 2000000000 107909468 675360
0b000302 0b000102 10000 100 2000000 2000000000 108011387 675360
0b001f02 0b000102 10000 100 2000000 2000000000 108998430 675360
0b000702 0b000102 10000 100 2000000 2000000000 109716928 675360
0b000902 0b000102 10000 100 2000000 2000000000 110309095 675360
0b000e02 0b000102 10000 100 2000000 2000000000 110384146 675360
0b001d02 0b000102 10000 100 2000000 2000000000 110849187 675360
0b000a02 0b000102 10000 100 2000000 2000000000 111088942 675360
0b001502 0b000102 10000 100 2000000 2000000000 111174264 675360
0b002002 0b000102 10000 100 2000000 2000000000 140630320 679520
0b002102 0b000102 10000 100 2000000 2000000000 146588002 679520


# 32条短流 1000B
## normal   重传时间9us  
            叶内            跨叶
0b000202    4752            8940
0b000502    4780            8947
0b000302    5100            9288
0b000602    5100            9316
0b000402    5448            9636
0b000802    5448            9636
0b000702    5796            9984
0b000902    5824            9984
0b000b02    6144            10332
0b000a02    6172            10332
0b000c02    6492            10680
0b000d02    6520            10680
0b000e02    6840            11028
0b001102    6868            11035
0b000f02    7188            11376
0b001302    7216            11376
0b001002    7536            11724
0b001802    7564            11724
0b001202    7884            12072
0b001902    7884            12072
0b001402    8232            12420
0b001c02    8232            12448
0b001502    8580            12768
0b001e02    8608            12768
0b001602    8928            13116
0b001f02    8928            13464
0b001702    9276            13812
0b001a02    9624            14160
0b001b02    9972            14508
0b001d02    10320           14856
0b002002    11318           15204
0b002102    11666           15552

叶内 min = 4752; avg = 7507; max = 11666;
跨叶 min = 8940; avg = 11726; max = 15552;

## seanet，重传时间9us  
            叶内            跨叶
0b000202    4754            8942
0b000602    4754            8970
0b000e02    5102            9290
0b000902    5130            9318
0b000f02    5450            9638
0b000a02    5478            9638
0b001002    5798            9986
0b001102    5826            9993
0b001402    6146            10334
0b001302    6174            10334
0b001502    6494            10682
0b001c02    6522            10682
0b001702    6842            11030
0b001f02    6928            11030
0b000502    7190            11378
0b000302    7276            11406
0b000802    7538            11726
0b000402    7624            11726
0b000d02    7886            12074
0b000c02    7972            12102
0b001902    8234            12422
0b001202    8320            12450
0b001602    8582            12770
0b001e02    8668            12798
0b001d02    8930            13118
0b001b02    9016            13118
0b001a02    9278            13466
0b002002    10322           13814
0b002102    10670           14162
0b000702    11018           14510
0b001802    11640           14858
0b000b02    11988           15206

叶内 min = 4754; avg = 8154.25; max = 17102;
跨叶 min = 8942; avg = 11655; max = 15206;

# ring allreduce 256条流 2MB (0->1, 1->2, 2->3, ..., 255->0)
## normal
min = 201662; avg = 210647; max = 374741;

## seanet
整体结果：
min = 191930; avg = 755600; max = 14538010;
跨叶通信：
min = 6386645; avg = 9069320; max = 14538010;


# ring allreduce 16条流 2MB 跨叶通信(15->16, 31->32, 47->48, ..., 255->0)
## normal
min = 201662; avg = 210647; max = 374741;
64486
64486
64486
64486
64486
64486
64486
70826
75275
75989
76441
76505
76505
76659
77055
77055

11769
## seanet
整体结果：
min = 191930; avg = 755600; max = 14538010;
41867

11769